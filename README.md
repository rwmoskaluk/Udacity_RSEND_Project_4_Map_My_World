# Udacity_RSEND_Project_4_Map_My_World

[image1]: ./pictures/rtabmap_mapping.png "Rtabmap visualization"
[image2]: ./pictures/rtabmap_databaseviewer_mapping.png "Rtabmap visualization database viewer"
[image3]: ./pictures/rviz_localization.png "Rviz localization with Rtabmap"
[image4]: ./pictures/Rtabmap_localization.png "Rtabmap localization"
[image5]: ./pictures/rtabmap_databaseviewer_bad.png "Rtabmap database viewer bad map"
[image6]: ./pictures/Rtabmap_database_viewer_3dmap_bad.png "3d Distorted map"
[image7]: ./pictures/Rtabmap_databaseviewer_final_v2.png "Rtabmap database viewer good map"
[image8]: ./pictures/Rtabmap_databaseviewer_3dmapv2.png "3d Non Distorted map"
[image9]: ./pictures/Rtabmap_databaseviewer_3dmap_v2_top.png "3d Non Distorted map top down view"


### Project Overview
The scope of this project was to learn more about the mapping package rtabmap in ROS.  This package allows for distinct features in an environment to be mapped which can then later be used for localization.  The robot was driven around using the Teleop package and data was then collected about the environment.

# How to run

Clone this repo

```
cd catkin_ws
catkin_make
source devel/setup.bash
```

Launch the world in terminal
```
source devel/setup.bash
roslaunch my_robot world.launch
```

Launch the mapping process in another terminal
```
source devel/setup.bash
roslaunch mapping mappling.launch
```

Launch Teleop package in another terminal
```
cd catkin_ws/src
git clone https://github.com/ros-teleop/teleop_twist_keyboard
cd ..
catkin_make
source devel/setup.bash
rosrun teleop_twist_keyboard teleop_twist_keyboard.py
```


## Mapping the Environment
To visualize the environment make sure to activate `Rtabmapviz GUI` as shown below.  This screen will show how many loop closures for the environment and give a visual representation of how the environment is mapped.

To turn the `Rtabmapviz GUI` on and off that can be done in the `mapping.launch` file

![alt text][image1]


After mapping has been done to a satisfactory level, one can view the saved data `rtabmap.db` which is stored in `/home/<hostname>/.ros/` where `<hostname>` denotes your computer's name

![alt text][image2]


## Example Running


<img src="pictures/rviz_mapping.gif?raw=true" width="720px">
<img src="pictures/rtabmap_mapping.gif?raw=true" width="720px">


# Localization

After using `rtabmap` to generate a map of the environment the results can be fed back into the system for better localization of the environment.  The launch file is modified from the `mapping.launch` to utilize this information


### Rtabmap Database Download
For this map a Rtabmap database has been generated by driving the robot around the environment with the `mapping.launch` node running.  This can be downloaded
```
https://drive.google.com/file/d/1468Ah1_e0PzqzaqfsB7qnLc4Lt_7Hlj2/view?usp=sharing
```
Make sure the `mapping.launch` process is closed from above and that the `rtabmap.db` is located in the appropiate directory `/home/<hostname>/.ros/` and named `rtabmap.db`


### Running localization
```
roslaunch mapping localization.launch
```

## Example Running

![alt text][image3]
![alt text][image4]

<img src="pictures/Rviz_localization.gif?raw=true" width="720px">
<img src="pictures/Rtabmap_localization.gif?raw=true" width="720px">



# Notes and Learnings


I had a lot of problems with map distortion during this project.  To resolve this the following was done:
1. Corrected the `wheelSeparation` value in `my_robot.gazebo` file so the odometry values were accurate
2. Slowed the robot down in the Teleop console, I found linear speed < 0.2 and angular speed < 0.2 worked well
3. Added unique items to my map.  Originally the map was bland and had very few unique features.  In each section of the map I added a unique feature (fire hydrant, stop sign, cube, sphere, etc...) for detection.
4. Added a Rtabmap param to help with filtering overtime as my setup experienced some drift and for larger environments this appears to help with multiple passes`<param name="Optimizer/Robust" type="string" value="true"/>`

With all of these added the occupency grid was able to be accurately generated with an accurate map as well (very little to none artifacts)
Bad map with distortion
![alt text][image5]
![alt text][image6]

Good map utilizing above settings
![alt text][image7]
![alt text][image8]
![alt text][image9]


<img src="pictures/3dmap_final.gif?raw=true" width="720px">




One key thing to note is with the rtabmap database viewer one can filter the mapped data and improve it's accuracy/remove noise.  This option can further be used to refine the map.


One key thing is to realize that `rtabmap` is utilizing a generic base_footprint for the frame_ids.  Changing the URDF or changing in the launch file is required to get the proper data from the topics.

Otherwise this error will occur where the data is not piped to the proper end topics during remapping.

```
[ WARN] [1633285689.744699814, 435.400000000]: /rtabmap/rtabmapviz: Did not receive data since
 5 seconds! Make sure the input topics are published ("$ rostopic hz my_topic") and the timest
amps in their header are set. If topics are coming from different computers, make sure the clo
cks of the computers are synchronized ("ntpdate"). If topics are not published at the same rat
e, you could increase "queue_size" parameter (current=10).
/rtabmap/rtabmapviz subscribed to (approx sync):
   /rtabmap/odom \
   /camera/rgb/image_raw \
   /camera/depth/image_raw \
   /camera/rgb/camera_info \
   /scan
```
